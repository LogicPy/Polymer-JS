
<!-- Time Tracker v2 / Polymer Project-->
<!-- Wayne Kenney / 2018 -->

<!-- Update: Using automatic node finding instead of document -->

<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/polymer.html">

<!-- Misc Components -->
<link rel="import" href="../../bower_components/vaadin-valo-theme/vaadin-date-picker.html">
<link rel="import" href="../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../bower_components/datetime-picker/datetime-picker.html">
<link rel="import" href="../../bower_components/time-diff/time-diff.html">

<!-- Paper Style Components -->
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<!-- Vaadin Grid -->
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-column-group.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-filter.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-tree-toggle.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-selection-column.html">

<!-- Iron Ajax -->
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css?family=Lobster" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=K2D" rel="stylesheet">

<!-- Database Components -->
<script src="../../bower_components/pouchdb/dist/pouchdb.min.js"></script>
<script src="../../bower_components/pouchdb-upsert/dist/pouchdb.upsert.js"></script>

<dom-module id="time-track-2-app">
  <template>
    <style>
      :host {
        display: block;
      }
      .App_Title
      {
        font-family: 'Lobster', cursive;
        font-size: 40px;
        margin-left: 20px;
      }
    .footer {
        position: fixed;
        left: 0;
        bottom: 0;
        width: 100%;
        color: black;
        text-align: center;
        border-top-color: black;
        border-top-width: 1px;
        border-top-style: solid;
        font-family: 'K2D', sans-serif;
    }

    .form_Whole
    {
      width:80%;
      margin-left: auto;
      margin-right: auto;
      display: block;
    }

    @media only screen and (max-width: 750px) {
      .form_Whole
      {
        width: 100%;
      }
    }
    </style>

  <h2 class="App_Title">Time Tracker 2</h2>

<div class="form_Whole">

  <!-- Grid Space -->
  <vaadin-grid id="grid" on-selected-items-changed="handleSelect" active-item="{{activeItem}}">

    <vaadin-grid-column>
      <template class="header">Task</template>
      <template>[[item.task]]</template>
    </vaadin-grid-column>
    <vaadin-grid-column>
      <template class="header">Start</template>
      <template>[[item.start]]</template>
    </vaadin-grid-column>
    <vaadin-grid-column>
      <template class="header">End</template>
      <template>[[item.end]]</template>
    </vaadin-grid-column>
    <vaadin-grid-column>
      <template class="header">Range</template>
      <template>[[item.range]]</template>
    </vaadin-grid-column>
  </vaadin-grid>

  <div class="form_Objects">
    <paper-input type="text" id="task" label="Tracker Name" value="{{item.task}}"></paper-input>
    <paper-button raised on-tap="createTracker" id="saveButton">Start Recording</paper-button>
    <paper-button raised on-tap="handleSave" id="saveButton">Stop and Save</paper-button>
    <paper-button raised on-tap="handleDelete" id="deleteButton" disabled>Delete</paper-button>
    <paper-button raised on-tap="handleSave" id="editButton" disabled>Edit</paper-button>
    <paper-input type="time" id="start" label="Start" on-value-changed="calcRange" value="{{item.start}}"></paper-input>
    <paper-input type="time" id="end" label="End" on-value-changed="calcRange" value="{{item.end}}"></paper-input>
    <paper-input id="rangeVal" label="Range" value="{{item.range}}">Range</paper-input>
    <paper-button raised on-tap="ClearClick">Clear</paper-button>
    <paper-button raised on-tap="helpClick">About</paper-button>
  </div>

</div>

  <div class="footer">
    <p>Time Tracker 2 / 2018</p>
  </div>

  </template>

  <script>

    Polymer({
      is: 'time-track-2-app',
      properties: {
        _db: Object,
        // Values
        item: {
          type: Object,
          value: function() {
            return {};
          },
        },
        activeItem: {
            observer: '_activeItemChanged'
          }
      },

      // Function: Database Definition
      created: function() {
        _db = new PouchDB('times');
      },

      _activeItemChanged: function(item) {
        this.$.grid.selectedItems = item ? [item] : [];
      },

      // Function: On_Load
      ready: function() {

        var grid = this.$.grid;

        var options = {};

        options.include_docs = true;

        // New row extraction routine
        _db.allDocs(options, function(error, response) {
        // map new array rows
        var rows = response.rows.map(function(row) {
          return row.doc;
          });
          grid.items = rows;
      })
    },

      // ----------------------------------------------
      // ------------- Trouble Functions --------------

      // Function: Selection
      handleSelect: function(e) {
        var grid = this.$.grid;
        // Clear
        // Clear
        if (grid.selectedItems.length > 0) {
          this.$.deleteButton.disabled = false;
          this.$.editButton.disabled = false;
          return;
        }
        else
        {
          this.set('item', {});
          this.$.deleteButton.disabled = true;
          this.$.editButton.disabled = true;
          return;
        }
        var index = grid.selectedItems[0];
        console.log(index);
        grid.get(index, function(err, item) {
          this.set('item', Object.assign({}, item));
          this.$.deleteButton.disabled = false;
          this.$.editButton.disabled = false;
        }.bind(this));
      },

      // Function: Delete
      handleDelete: function() {
        var grid = this.$.grid;
        _db.remove(this.item._id, this.item._rev).then(function(doc) {
          grid.item.clear();
        }).then(function(doc) {
          // update Grid
          grid.clearCache();
        }).catch(function(err) {
          console.log(err);
        });
      },

        _activeItemChanged: function(item) {
          this.$.grid.selectedItems = item ? [item] : [];
        },

      // ----------------------------------------------
      // ------------- Working Functions --------------

      // Function: Activate Tracker Application
      createTracker: function(){
        if(this.$.task.value == "")
        {
          this.$.task.value = "Tracker";
        }
        else
        {
          // Textbox already occupied
        }
        this.$.start.value = (new Date).toTimeString().slice(0,8);

      },

      // Function: Save (works)
      handleSave: function() {
          this.$.end.value = (new Date).toTimeString().slice(0,8);
          var grid = this.$.grid;
          var newDoc = Object.assign({}, this.item);
          if (!newDoc.hasOwnProperty('_id')) {
            newDoc._id = new Date().toISOString();
          }
          _db.upsert(newDoc._id, function(doc) {
            newDoc._rev = doc._rev;
            return newDoc;
          }).then(function(doc) {


          }).catch(function(err) {
            console.log(err)
          });
      
          this.$.task.value = "";
          this.$.start.value = "";
          this.$.end.value = "";
          this.$.rangeVal.value = "";

      },

    // Function: Clear Text Fields
    ClearClick: function(){
        this.$.task.value = "";
        this.$.start.value = "";
        this.$.end.value = "";
        this.$.rangeVal.value = "";   
    },

    // Function: Help Button MessageBox
    helpClick: function(){
      alert("This is an updated version of Time Tracker that uses only Polymer 2.x web components including the most up-to-date version of Vaadin Grid (5.1.0).\n\n 1) Create tracker by clicking 'Start Recording'\n 2) Tracking will begin at your current time and end when you click 'Stop and Save'\n 3) Tracker details including start time, end time and duration between the two times will be logged and saved.\n\n Coded by Wayne")
    },

    // Function: Calculate Range (Temporary)
    calcRange: function() {
      var smon = this.$.start.value;
      var fmon = this.$.end.value;
        var diff = 0 ;
        if (smon && fmon) {
          smon = ConvertToSeconds(smon);
          fmon = ConvertToSeconds(fmon);
          diff = Math.abs( fmon - smon );
          this.$.rangeVal.value = secondsTohhmmss(diff);
        }
        function ConvertToSeconds(time) {
          var splitTime = time.split(":");
          return splitTime[0] * 3600 + splitTime[1] * 60;
        }
        function secondsTohhmmss(secs) {
          var hours = parseInt(secs / 3600);
          var seconds = parseInt(secs % 3600);
          var minutes = parseInt(seconds / 60) ;
          return hours + "hours : " + minutes + "minutes ";
        } 
    }
  });


  </script>
</dom-module>