
<!-- Time Tracker v2 / Polymer Project-->
<!-- Wayne Kenney / 2018 -->

<!-- Update: Using automatic node finding instead of document -->

<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/polymer.html">

<!-- Misc Components -->
<link rel="import" href="../../bower_components/vaadin-valo-theme/vaadin-date-picker.html">
<link rel="import" href="../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../bower_components/datetime-picker/datetime-picker.html">
<link rel="import" href="../../bower_components/time-diff/time-diff.html">

<!-- Paper Style Components -->
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<!-- Vaadin Grid -->
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-column-group.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-filter.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-tree-toggle.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-selection-column.html">

<!-- Iron Ajax -->
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css?family=Lobster" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=K2D" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Electrolize" rel="stylesheet">

<!-- Database Components -->
<script src="../../bower_components/pouchdb/dist/pouchdb.min.js"></script>
<script src="../../bower_components/pouchdb-upsert/dist/pouchdb.upsert.js"></script>

<dom-module id="time-track-2-app">
  <template>
    <style>
      :host 
      {
        display: block;
      }
      .App_Title
      {
        font-family: 'Lobster', cursive;
        font-size: 40px;
        margin-left: 20px;
      }
      .footer 
      {
        position: fixed;
        left: 0;
        bottom: 0;
        width: 100%;
        color: black;
        text-align: center;
        border-top-color: black;
        border-top-width: 1px;
        border-top-style: solid;
        font-family: 'K2D', sans-serif;
      }

      .form_Whole
      {
        width:80%;
        margin-left: auto;
        margin-right: auto;
        display: block;
      }

      .statusLabel
      {
        color: #778899;
        font-family: 'Electrolize', sans-serif;
      }

      #msStart, #msEnd
      {
        display: none;
      }

      @media only screen and (max-width: 750px) {
      .form_Whole
      {
        width: 100%;
      }
    }
    </style>

  <h2 class="App_Title">Time Tracker 2</h2>

<div class="form_Whole">

  <!-- Grid Space -->
  <vaadin-grid id="grid" on-selected-items-changed="handleSelect" active-item="{{activeItem}}">

    <vaadin-grid-column>
      <template class="header">Task</template>
      <template>[[item.task]]</template>
    </vaadin-grid-column>
    <vaadin-grid-column>
      <template class="header">Start</template>
      <template>[[item.start]]</template>
    </vaadin-grid-column>
    <vaadin-grid-column>
      <template class="header">End</template>
      <template>[[item.end]]</template>
    </vaadin-grid-column>
    <vaadin-grid-column>
      <template class="header">Range</template>
      <template>[[item.range]]</template>
    </vaadin-grid-column>
  </vaadin-grid>

  <input id="msStart" value$="{{StartSeconds}}"><br>
  <input id="msEnd" value$="{{EndSeconds}}"><br>

  <time-diff id="diff"></time-diff>

  <div class="form_Objects">
    <paper-input type="text" id="task" label="Tracker Name" value="{{timeKey.task}}" value$="{{taskValue}}"></paper-input>
    <paper-button raised on-tap="createTracker" id="saveButton" disabled$="{{ saveBtn }}">Start Recording</paper-button>
    <paper-button raised on-tap="handleSave" id="stopButton" disabled$="{{ stopBtn }}">Stop and Save</paper-button>
    <paper-button raised on-tap="handleDelete" id="deleteButton" disabled$="{{ DelBtn }}">Delete</paper-button>
    <paper-button raised on-tap="handleEdit" id="editButton" disabled$="{{ EditBtn }}">Edit</paper-button>
    <paper-button raised on-tap="handleClear" id="clearButton">Clear</paper-button>

    <br><br><label class="statusLabel" id="statuslbl">{{statusOutput}}</label>

    <paper-input style$="visibility: {{startVisibility}};" type="time" id="start" label="Start" on-value-changed="calcRange2" value="{{timeKey.start}}" value$="{{startValue}}"></paper-input>
    <paper-input style$="visibility: {{endVisibility}};" type="time" id="end" label="End" on-value-changed="calcRange2" value="{{timeKey.end}}" value$="{{endValue}}"></paper-input>
    <paper-input id="rangeVal" label="Range" value="{{timeKey.range}}" value$="{{rangeValue}}" style$="visibility: {{rangeVisibility}};">Range</paper-input>

  </div>

</div>

</template>

  <script>

    Polymer({
      is: 'time-track-2-app',
      properties: {
        _db: Object,
        statusOutput: String,

        // Grid Items
        timeKey: {
          type: Object,
          value: function() {
            return {};
          },
        },
        // Active Grid Item / Selection
        activeItem: {
            observer: '_activeItemChanged'
          }
      },

      // Function: Database Definition
      created: function() {
        _db = new PouchDB('times');

      },

      // Function: On_Load
      ready: function() {
        // Stop button disabled upon load to prevent blank submissions
        this.stopBtn = true;
        // Range is a computed value
        this.rangeVisibility = 'hidden';
        // Instructions for activation
        this.statusOutput = "Press 'Start Recording' to begin";

        // Vaadin Grid + PouchDB
        var grid = this.$.grid;

        var options = {};

        options.include_docs = true;

        // New row extraction routine
        _db.allDocs(options, function(error, response) {
        // map new array 'rows'
        this.timeKey = response.rows.map(function(row) {
          return row.doc;
          });
          // Append local db rows to Vaadin grid
          grid.items = this.timeKey;
      })
    },

      // Function: Selection
      handleSelect: function(e) {
        var grid = this.$.grid;

        // Determine which item is selected in this construct
        if (grid.selectedItems.length > 0) {
            // If not selected, disable buttons
            this.DelBtn = false;
            this.EditBtn = false;     
            this.startVisibility = 'visible';
            this.endVisibility = 'visible';
        }
        else
        {
            // Otherwise, enable
            this.DelBtn = true;
            this.EditBtn = true;
            this.startVisibility = 'hidden';
            this.endVisibility = 'hidden';
        }
          try
          {
            // Prepare for edit
            this.taskValue = grid.selectedItems[0].task;
            this.startValue = grid.selectedItems[0].start;
            this.endValue = grid.selectedItems[0].end;
            this.rangeValue = grid.selectedItems[0].range;
          }
          catch{

          }

      },

      // Function: Edit
      handleEdit: function(){
        var grid = this.$.grid;

        var newDoc = Object.assign({}, this.timeKey);
        _db.upsert(grid.selectedItems[0]._id, function(doc) {
        grid.selectedItems[0]._rev = grid.selectedItems[0]._rev;
        return newDoc;
      });
        // Temporary Grid Refresh Solution
        grid.clearCache();
        location.reload();
      },

      // Function: Clear
      handleClear: function() {
        var grid = this.$.grid;
        _db.allDocs({include_docs: true}).then(allDocs => {
        return allDocs.rows.map(row => {
          return {_id: row.id, _rev: row.doc._rev, _deleted: true};
        });
        }).then(deleteDocs => {
          return _db.bulkDocs(deleteDocs);
        });

        // Temporary Grid Refresh Solution
        grid.clearCache();
        location.reload();
      },

      // Function: Delete
      handleDelete: function() {
        var grid = this.$.grid;

        // grid.selectedItems contains _id and _rev. No more selection.selected...
        _db.remove(grid.selectedItems[0]._id, grid.selectedItems[0]._rev);

        // Temporary Grid Refresh Solution
        grid.clearCache();
        location.reload();
      },

      // Related to Item Selection (Recycled from documentation)
      _activeItemChanged: function(item) {
        this.$.grid.selectedItems = item ? [item] : [];
      },

      // Function: Activate Tracker Application
      createTracker: function(){
        if(this.$.task.value == "")
        {
          this.taskValue = "Tracker";
        }
        else
        {
          // Textbox already occupied
        }

        this.StartSeconds = Date.now();

        // Starting Time
        this.startValue = (new Date).toTimeString().slice(0,8);
        this.saveBtn = true;
        this.stopBtn = false;
        this.statusOutput = "Recording Tracker - Press 'Stop and Save' to stop recording";

      },

      // Function: Save
      handleSave: function() {
          var diff = this.$.diff;
          var min = 0;
          var max = 10000;

          this.endValue = (new Date).toTimeString().slice(0,8);
          this.EndSeconds = Date.now();

          diff.from = this.StartSeconds;
          diff.to = this.EndSeconds;

          diff.minUnit = min.value;
          diff.maxUnit = max.value;

          this.rangeValue = diff.diff;

          var grid = this.$.grid;
          var newDoc = Object.assign({}, this.timeKey);
          if (!newDoc.hasOwnProperty('_id')) {
            newDoc._id = new Date().toISOString();
          }
          _db.upsert(newDoc._id, function(doc) {
            newDoc._rev = doc._rev;
            return newDoc;
          }).then(function(doc) {


          }).catch(function(err) {
            console.log(err)
          });
      
          // Save button re-enabled after pressing 'Stop'
          this.saveBtn = false;

          // Reset Values
          this.taskValue = "";
          this.startValue = "";
          this.endValue = "";
          this.rangeValue = "";

          // Supposed to refresh grid, but....
          grid.clearCache();
          location.reload();

      },

    // Function: Calculate Range (Primitive)
    calcRange: function() {
      var smon = this.startValue;
      var fmon = this.endValue;
        var diff = 0 ;
        if (smon && fmon) {
          smon = ConvertToSeconds(smon);
          fmon = ConvertToSeconds(fmon);
          diff = Math.abs( fmon - smon );
          this.rangeValue = secondsTohhmmss(diff);
        }
        function ConvertToSeconds(time) {
          var splitTime = time.split(":");
          return splitTime[0] * 3600 + splitTime[1] * 60;
        }
        function secondsTohhmmss(secs) {
          var hours = parseInt(secs / 3600);
          var seconds = parseInt(secs % 3600);
          var minutes = parseInt(seconds / 60) ;
          return hours + "hours : " + minutes + "minutes ";
        } 
    },


    // Function: New Range Calculator using Time-Diff Component
    calcRange2: function() {
      var diff = this.$.diff;
      var min = 0;
      var max = 10000;

      diff.from = this.StartSeconds;
      diff.to = this.EndSeconds;

      diff.minUnit = min.value;
      diff.maxUnit = max.value;

      this.rangeValue = diff.diff;
    },

  });


  </script>
</dom-module>